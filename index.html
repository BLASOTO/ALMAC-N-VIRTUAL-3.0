<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Almacén Virtual 2D</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui,Arial,sans-serif;margin:20px;max-width:1200px}
.top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
select,input,button,textarea{padding:9px 12px;font-size:14px;border:1px solid #ccc;border-radius:10px}
button{cursor:pointer}
.muted{color:#666;font-size:12px}

/* Grid */
.grid{margin-top:18px;display:grid;grid-template-columns:110px repeat(4, 1fr);gap:12px}
.header{font-weight:700;text-align:center}
.rowlabel{font-weight:700;text-align:center;display:flex;align-items:center;justify-content:center;border:1px dashed #ddd;border-radius:14px}

.cell{border-radius:14px;padding:12px;min-height:92px;border:1px solid #ccc;display:flex;flex-direction:column;gap:6px}
.cell:hover{outline:2px solid rgba(0,0,0,.08)}

.vacio{background:#f2f2f2}
.ok{background:#e6f4ea}
.bloqueado{background:#fdecea}
.revision{background:#fff7e6}

.code{font-weight:800}
.small{font-size:12px;color:#444}

/* Leyenda */
.legend{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.pill{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid #ddd;font-size:12px}
.pV{background:#f2f2f2}
.pOK{background:#e6f4ea}
.pB{background:#fdecea}
.pR{background:#fff7e6}

/* Tabla resumen */
#tablaResumen{
  border-collapse:collapse;
  margin-top:18px;
  min-width:700px;
}
#tablaResumen th,#tablaResumen td{
  border:1px solid #ddd;
  padding:8px 12px;
  text-align:left;
}
#tablaResumen th{
  background:#f2f2f2;
  font-weight:700;
}

/* Modal */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:18px}
.modal{background:#fff;border-radius:16px;border:1px solid #eee;max-width:560px;width:100%;padding:16px}
.modal h3{margin:0 0 6px 0}
.form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.full{grid-column:1/-1}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

/* Contenedor capturable */
#captureArea{
  background:#fff;
}
</style>

<!-- ✅ Librería para capturar pantalla -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>

<body>

<div class="top">
  <h2 style="margin:0">Almacén Virtual</h2>

  <label>
    Almacén:
    <select id="almacen">
      <option value="ALM1">ALM1</option>
      <option value="ALM2">ALM2</option>
    </select>
  </label>

  <label>
    Usuario:
    <input id="usuario" placeholder="Ej: Carlos" />
  </label>

  <button id="btnActualizar">Actualizar</button>
  <button id="btnCaptura">Guardar captura</button>
  <span id="estado" class="muted">—</span>
</div>

<div id="captureArea">
  <div class="legend">
    <span class="pill pV">VACIO</span>
    <span class="pill pOK">OK</span>
    <span class="pill pB">BLOQUEADO</span>
    <span class="pill pR">REVISIÓN</span>
  </div>

  <div id="grid" class="grid"></div>

  <h3 style="margin:18px 0 0 0">Resumen de inventario (Producto + Lote)</h3>
  <table id="tablaResumen">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Lote</th>
        <th>Cantidad total</th>
        <th>Unidad</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- MODAL -->
<div id="backdrop" class="backdrop">
  <div class="modal">
    <h3 id="mTitle">Editar ubicación</h3>
    <div id="mSub" class="muted"></div>

    <div class="form">
      <input id="mProducto" class="full" placeholder="Producto" />
      <input id="mCantidad" placeholder="Cantidad" />
      <input id="mUnidad" placeholder="Unidad" />
      <input id="mLote" placeholder="Lote" />
      <input id="mFecha" placeholder="Fecha entrada (YYYY-MM-DD)" />

      <select id="mEstado">
        <option value="">(auto)</option>
        <option value="VACIO">VACIO</option>
        <option value="OK">OK</option>
        <option value="BLOQUEADO">BLOQUEADO</option>
        <option value="REVISIÓN">REVISIÓN</option>
      </select>

      <textarea id="mObs" class="full" rows="3" placeholder="Observaciones"></textarea>
      <input id="mNota" class="full" placeholder="Nota para MOVIMIENTOS (opcional)" />
    </div>

    <div class="actions">
      <button id="mCancel">Cancelar</button>
      <button id="mSave">Guardar</button>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_XjZgMWd3LjbY0H7PfHyNi38CBGLhghoKkoi2Q6xkHv7IXGYYr3RZvcR2NCjBlZuU/exec";
const FILAS = ["A","B","C","D"];
const COLUMNAS = [1,2,3,4];

let cache = [];
let selected = null;

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function setStatus(t){ document.getElementById("estado").textContent = t; }

/* JSONP */
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const s = document.createElement("script");
    window[cb] = d => { delete window[cb]; s.remove(); resolve(d); };
    s.onerror = () => { delete window[cb]; s.remove(); reject(new Error("JSONP error")); };
    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    document.body.appendChild(s);
  });
}

async function cargar(){
  const alm = document.getElementById("almacen").value;
  setStatus("Cargando…");
  try{
    const res = await jsonp(`${SCRIPT_URL}?action=get&almacen=${encodeURIComponent(alm)}`);
    if (!res || !res.ok) throw new Error(res?.error || "Respuesta inválida");
    cache = res.data || [];
    pintar(cache);
    pintarResumen(cache);
    setStatus(`Cargadas ${cache.length} ubicaciones`);
  }catch(e){
    setStatus("Error: " + e.message);
    console.error(e);
  }
}

function claseEstado(estado){
  const e = String(estado||"").toUpperCase().trim();
  if (e === "OK" || e === "OCUPADO") return "ok";
  if (e === "BLOQUEADO") return "bloqueado";
  if (e === "REVISIÓN" || e === "REVISION") return "revision";
  return "vacio";
}

function div(c,t){const d=document.createElement("div");d.className=c;d.textContent=t;return d}

/* Grid */
function pintar(data){
  const g = document.getElementById("grid");
  g.innerHTML = "";

  g.appendChild(div("header",""));
  COLUMNAS.forEach(c => g.appendChild(div("header","Col "+c)));

  FILAS.forEach(f=>{
    g.appendChild(div("rowlabel","Fila "+f));
    COLUMNAS.forEach(c=>{
      const u = data.find(x=>x.FILA===f && Number(x.COLUMNA)===c);

      const codigo = u?.UBICACION_CODIGO || "";
      const producto = (u?.PRODUCTO || "").trim() ? u.PRODUCTO : "— vacío —";
      const qtyUnit = ((u?.CANTIDAD || "") + " " + (u?.UNIDAD || "")).trim();

      const lote = (u?.LOTE || "").trim();
      const loteTxt = lote ? `Lote: ${lote}` : "";

      const est = (u?.ESTADO || "VACIO");

      const d = document.createElement("div");
      d.className = "cell " + claseEstado(est);
      d.innerHTML = `
        <div class="code">${escapeHtml(codigo)}</div>
        <div>${escapeHtml(producto)}</div>
        <div class="muted">${escapeHtml(qtyUnit)}</div>
        ${loteTxt ? `<div class="muted">${escapeHtml(loteTxt)}</div>` : ``}
        <div class="small muted">${escapeHtml(est)}</div>
      `;
      d.onclick = ()=>abrirModal(u);
      g.appendChild(d);
    });
  });
}

/* Resumen producto + lote */
function pintarResumen(data){
  const tbody = document.querySelector("#tablaResumen tbody");
  tbody.innerHTML = "";

  const resumen = {};

  data.forEach(u=>{
    const producto = (u?.PRODUCTO || "").trim();
    if (!producto) return;

    const lote = (u?.LOTE || "").trim();
    const unidad = (u?.UNIDAD || "").trim();

    const cantRaw = String(u?.CANTIDAD || "").trim();
    if (!cantRaw) return;

    const cant = Number(cantRaw.replace(",", "."));
    if (!isFinite(cant) || cant === 0) return;

    const key = `${producto}||${lote}||${unidad}`;
    if (!resumen[key]) resumen[key] = { producto, lote, unidad, total: 0 };
    resumen[key].total += cant;
  });

  const items = Object.values(resumen).sort((a,b)=>{
    const p = a.producto.localeCompare(b.producto);
    if (p !== 0) return p;
    const l = a.lote.localeCompare(b.lote);
    if (l !== 0) return l;
    return a.unidad.localeCompare(b.unidad);
  });

  if (items.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">Sin stock (no hay cantidades registradas)</td>`;
    tbody.appendChild(tr);
    return;
  }

  items.forEach(it=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(it.producto)}</td>
      <td>${escapeHtml(it.lote || "—")}</td>
      <td>${escapeHtml(it.total)}</td>
      <td>${escapeHtml(it.unidad)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* Modal */
const bd = document.getElementById("backdrop");
const mEstado = document.getElementById("mEstado");

function abrirModal(u){
  selected=u;
  document.getElementById("mTitle").textContent="Editar "+u.UBICACION_CODIGO;
  document.getElementById("mSub").textContent=`Fila ${u.FILA} · Col ${u.COLUMNA}`;
  mEstado.value="";
  document.getElementById("mProducto").value=u.PRODUCTO||"";
  document.getElementById("mCantidad").value=u.CANTIDAD||"";
  document.getElementById("mUnidad").value=u.UNIDAD||"";
  document.getElementById("mLote").value=u.LOTE||"";
  document.getElementById("mFecha").value=u.FECHA_ENTRADA||"";
  document.getElementById("mObs").value=u.OBSERVACIONES||"";
  document.getElementById("mNota").value="";
  bd.style.display="flex";
}

document.getElementById("mCancel").onclick=()=>bd.style.display="none";
bd.addEventListener("click",(e)=>{ if(e.target===bd) bd.style.display="none"; });

document.getElementById("mSave").onclick=async ()=>{
  if(!selected) return;

  const payload={
    ubicacion_codigo:selected.UBICACION_CODIGO,
    producto:document.getElementById("mProducto").value.trim(),
    cantidad:document.getElementById("mCantidad").value.trim(),
    unidad:document.getElementById("mUnidad").value.trim(),
    lote:document.getElementById("mLote").value.trim(),
    fecha_entrada:document.getElementById("mFecha").value.trim(),
    estado:mEstado.value,
    observaciones:document.getElementById("mObs").value.trim(),
    usuario:document.getElementById("usuario").value.trim(),
    nota:document.getElementById("mNota").value.trim()
  };

  setStatus("Guardando…");
  try{
    const res = await jsonp(`${SCRIPT_URL}?action=update&data=${encodeURIComponent(JSON.stringify(payload))}`);
    if (!res || !res.ok) throw new Error(res?.error || "No se pudo guardar");
    bd.style.display="none";
    await cargar();
    setStatus("Guardado ✅");
  }catch(e){
    console.error(e);
    setStatus("Error guardando: " + e.message);
  }
};

/* ✅ CAPTURA Y SUBIDA A DRIVE */
function pad2(n){ return String(n).padStart(2,"0"); }
function todayFolder(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function timestampName(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
}

document.getElementById("btnCaptura").onclick = async ()=>{
  try{
    const alm = document.getElementById("almacen").value;
    const dateFolder = todayFolder();
    const filename = `${alm}_${timestampName()}.png`;

    setStatus("Generando captura…");

    const area = document.getElementById("captureArea");
    const canvas = await html2canvas(area, { scale: 2, useCORS: true });
    const imageData = canvas.toDataURL("image/png");

    setStatus("Subiendo a Drive…");

    const resp = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ almacen: alm, dateFolder, filename, imageData })
    });

    const json = await resp.json();
    if (!json.ok) throw new Error(json.error || "No se pudo guardar en Drive");

    setStatus(`Captura guardada ✅ (${json.folderName})`);
    // opcional: abrir el archivo
    window.open(json.fileUrl, "_blank");

  }catch(err){
    console.error(err);
    setStatus("Error captura: " + err.message);
    alert("Error guardando captura: " + err.message);
  }
};

document.getElementById("btnActualizar").onclick=cargar;
document.getElementById("almacen").onchange=cargar;
cargar();
</script>

</body>
</html>
