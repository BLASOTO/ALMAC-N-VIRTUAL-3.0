<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Almacén Virtual 2D</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, Arial, sans-serif;
  margin: 20px;
  max-width: 1100px;
}

.top {
  display: flex;
  gap: 12px;
  align-items: center;
}

select, button {
  padding: 8px 12px;
  font-size: 14px;
}

.grid {
  margin-top: 20px;
  display: grid;
  grid-template-columns: 80px repeat(4, 1fr);
  gap: 10px;
}

.header, .rowlabel {
  font-weight: bold;
  text-align: center;
}

.cell {
  border-radius: 12px;
  padding: 10px;
  min-height: 80px;
  border: 1px solid #ccc;
}

.vacio {
  background: #f2f2f2;
}

.ocupado {
  background: #e6f4ea;
}

.code {
  font-weight: bold;
}

.muted {
  color: #666;
  font-size: 12px;
}
</style>
</head>

<body>

<div class="top">
  <h2>Almacén Virtual</h2>

  <select id="almacen">
    <option value="ALM1">ALM1</option>
    <option value="ALM2">ALM2</option>
  </select>

  <button onclick="cargar()">Actualizar</button>
  <span id="estado" class="muted">Cargando…</span>
</div>

<div id="grid" class="grid"></div>

<script>
/********************
 * CONFIG
 ********************/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_XjZgMWd3LjbY0H7PfHyNi38CBGLhghoKkoi2Q6xkHv7IXGYYr3RZvcR2NCjBlZuU/exec";
const FILAS = ["A","B","C","D"];
const COLUMNAS = [1,2,3,4];

/********************
 * JSONP HELPER
 ********************/
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");

    window[cb] = (data) => {
      delete window[cb];
      script.remove();
      resolve(data);
    };

    script.onerror = () => {
      delete window[cb];
      script.remove();
      reject(new Error("Error JSONP"));
    };

    const sep = url.includes("?") ? "&" : "?";
    script.src = url + sep + "callback=" + cb;
    document.body.appendChild(script);
  });
}

/********************
 * LOAD DATA
 ********************/
async function cargar() {
  const alm = document.getElementById("almacen").value;
  document.getElementById("estado").textContent = "Cargando…";

  try {
    const url = `${SCRIPT_URL}?action=get&almacen=${encodeURIComponent(alm)}`;
    const res = await jsonp(url);

    if (!res || !res.ok) {
      throw new Error("Respuesta inválida");
    }

    pintar(res.data || []);
    document.getElementById("estado").textContent =
      `OK · ${res.data.length} ubicaciones`;

  } catch (err) {
    console.error(err);
    document.getElementById("estado").textContent = "Error al cargar";
  }
}

/********************
 * DRAW GRID
 ********************/
function pintar(data) {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  // Header
  grid.appendChild(cell("",""));
  COLUMNAS.forEach(c => grid.appendChild(cell("header","Col " + c)));

  // Rows
  FILAS.forEach(f => {
    grid.appendChild(cell("rowlabel","Fila " + f));

    COLUMNAS.forEach(c => {
      const u = data.find(x => x.FILA === f && Number(x.COLUMNA) === c);
      const estado = u && u.ESTADO === "VACIO" ? "vacio" : "ocupado";

      const div = document.createElement("div");
      div.className = "cell " + estado;

      div.innerHTML = `
        <div class="code">${u?.UBICACION_CODIGO || ""}</div>
        <div>${u?.PRODUCTO || "— vacío —"}</div>
        <div class="muted">${u?.CANTIDAD || ""} ${u?.UNIDAD || ""}</div>
      `;

      grid.appendChild(div);
    });
  });
}

function cell(cls, text) {
  const d = document.createElement("div");
  if (cls) d.className = cls;
  d.textContent = text;
  return d;
}

/********************
 * INIT
 ********************/
cargar();
</script>

</body>
</html>
